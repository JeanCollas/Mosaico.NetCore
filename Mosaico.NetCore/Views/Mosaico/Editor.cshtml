@model MosaicoEmail

@{
    Layout = null;

    string templatePath;

    switch (Model.Template)
    {
        case MosaicoTemplate.TEDC15: templatePath = "/templates/tedc15/template-tedc15.html"; break;
        case MosaicoTemplate.Tutorial: templatePath = "/templates/tutorial/template-tutorial.html"; break;
        case MosaicoTemplate.Versafix1:
        default: templatePath = "/templates/versafix-1/template-versafix-1.html"; break;
    }

    string metadata = null;
    string content = null;

    if (Model.Id > 0)
    {
        metadata = Model.Metadata;
        content = Model.Content;
    }
}

<!DOCTYPE html>
<html>
<head>
    <title>@ViewBag.Title</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <link rel="canonical" href="http://mosaico.io" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />

    <meta name="viewport" content="width=1024, initial-scale=1">

    <link rel="stylesheet" href="/mosaico/mosaico-material.min.css" />
    <link rel="stylesheet" href="/mosaico/vendor/notoregular/stylesheet.css" />

    <script src="/mosaico/vendor/jquery.min.js"></script>
    <script src="/mosaico/vendor/knockout.js"></script>
    <script src="/mosaico/vendor/jquery-ui.min.js"></script>
    <script src="/mosaico/vendor/jquery.ui.touch-punch.min.js"></script>
    <script src="/mosaico/vendor/load-image.all.min.js"></script>
    <script src="/mosaico/vendor/canvas-to-blob.min.js"></script>
    <script src="/mosaico/vendor/jquery.iframe-transport.js"></script>
    <script src="/mosaico/vendor/jquery.fileupload.js"></script>
    <script src="/mosaico/vendor/jquery.fileupload-process.js"></script>
    <script src="/mosaico/vendor/jquery.fileupload-image.js"></script>
    <script src="/mosaico/vendor/jquery.fileupload-validate.js"></script>
    <script src="/mosaico/vendor/knockout-jqueryui.min.js"></script>
    <script src="/mosaico/vendor/tinymce.min.js"></script>
    <script src="/mosaico/mosaico.min.js"></script>
    <script>
        $(function () {
            if (!Mosaico.isCompatible()) {
                alert('Update your browser!');
                return;
            }
            // Full URL required for /dl (download and email test). Otherwise the links don't work.
            var url = location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '');

            var basePath = url + '/mosaico';
            var plugins;

            plugins = [
                function (viewModel) {
                    var saveCmd = {
                        name: 'Save',
                        enabled: ko.observable(true)
                    };

                    saveCmd.execute = function () {
                        saveCmd.enabled(false);
                        viewModel.metadata.changed = Date.now();
                        if (typeof viewModel.metadata.key == 'undefined') {
                            var rnd = Math.random().toString(36).substr(2, 7);
                            viewModel.metadata.key = rnd;
                        }

                        var postData = {
                            //csrf_token: 'yourCsrfValueHere', // this is only required if your back-end requires csrf token
                            id: @Model.Id,
                            name: '@Model.Name', //TODO (Provide input box for user to give name to template) - better yet: provide name from previous screen, which should be a grid showing existing templates to edit or a button to create a new one
                            template: @((byte)Model.Template),
                            metadata: viewModel.exportMetadata(),
                            content: viewModel.exportJSON(),
                            html: viewModel.exportHTML()
                        };

                        $.post('/mosaico/save', postData)
                            .done(function () {
                                viewModel.notifier.success(viewModel.t('Successfully saved.'));
                            })
                            .fail(function (jqXHR, textStatus, error) {
                                console.log(textStatus);
                                console.log(error);
                                console.log(jqXHR);
                                viewModel.notifier.error(viewModel.t('Saving failed. Please try again in a few moments or contact us.'));
                            })
                            .always(function () {
                                saveCmd.enabled(true);
                            });
                    };

                    viewModel.save = saveCmd;
                },
            ];

            @if (string.IsNullOrEmpty(metadata))
            {
                @:var metadata = undefined;
            }
            else
            {
                @:var metadata = ko.utils.parseJson('@Html.Raw(metadata.Replace(@"\", @"\\"))');
            }

            @if (string.IsNullOrEmpty(content))
            {
                @:var content = undefined;
            }
            else
            {
                @:var content = ko.utils.parseJson('@Html.Raw(content.Replace(@"\", @"\\"))');
            }

            Mosaico.start({
                imgProcessorBackend: basePath + '/img/',
                emailProcessorBackend: basePath + '/dl/',
                titleToken: "MOSAICO Responsive Email Designer",
                //onSave: function (saveObject) { alert('hi'); },
                fileuploadConfig: {
                    url: basePath + '/upload/'
                }
            }, '@templatePath', metadata, content, plugins);
        });
    </script>
</head>
<body class="mo-standalone">
</body>
</html>